# Combine yield and input datasets

## Preparation

### Read datasets

**Yield**

```{r }
#--- yield ---#
yield_polygons <- here("Data/Growers", ffy, "Intermediate/yield_polygons.rds") %>% 
  readRDS() %>%
  mutate(yield_area = as.numeric(st_area(.))) %>% 
  dplyr::select(yield_id, yield_area, yield_vol)

#=== vis ===#
tm_shape(filter(yield_polygons, ol_yield_vol == 0 & ol_speed == 0)) +
  tm_fill(col = "yield_vol", style = "order")

```

**Inputs**

```{r }

input_polygons <- 
  trial_info %>% 
  rowwise() %>% 
  mutate(
    input_file_name = here(
      "Data/Growers", ffy, "Intermediate", 
      paste0("aa-", input_type, "-", form, ".rds")
    )
  ) %>% 
  mutate(
    input_polygons = list(
      readRDS(input_file_name)
    )
  ) 

#=== vis ===#
input_polygons %>% 
mutate(
  tm_map = list(
    tm_shape(input_polygons) +
      tm_fill(
        col = "input_rate", 
        title = paste0(input_type, "-", form)
      )
  )
) %>% 
.$tm_map

``` 

**Trial Design**

```{r }
trd_polygons <- 
  here(
    "Data/Growers", ffy, "TrialDesign",
    paste0(trial_pars$tr_design_data, ".shp")
  ) %>% 
  st_read() 

#=== vis ===#
tm_shape(trd_polygons) +
  tm_polygons(col = "Trt")

```

**Base input rate**

```{r }
n_base <- trial_pars$n_base_rate
```

## Data alignment checks

### Yield and inputs

```{r }
tm_alignment <- 
  input_polygons %>% 
  mutate(
    tm_map = list(
      tm_shape(input_polygons) +
        tm_borders(lwd = 0.2) +
      tm_shape(st_centroid(yield_polygons)) +
        tm_dots(col = "blue", title = "Yield Points")
    )
  )

tm_alignment$tm_map 

```

## Flag unreliable polygons

### Check the overlap and find area-weighted input rates

```{r }

input_pct <- 
  input_polygons %>% 
  #=== intersect yield and input polygons to check overlaps ===#
  mutate(yield_input_int = list(
    st_intersection(
      dplyr::select(yield_polygons, yield_id, yield_area),
      dplyr::select(input_polygons, input_rate)
    ) %>% 
    #=== percentage of overlap relative to the are of a yield polygon ===#
    mutate(sub_pct = as.numeric(st_area(.)) / yield_area) %>%
    data.table()
  )) %>% 
  mutate(input_pct_data = list(
    copy(yield_input_int) %>%
    #--- total sub_pct by yield polygon ---#
    .[, tot_sub_pct := sum(sub_pct), by = yield_id] %>%
    #--- calculate sub_pct-weighted MEAN of applied rate ---#
    .[, wm_input_rate := sum(sub_pct * input_rate) / tot_sub_pct, by = yield_id] %>%
    #--- weighted deviation from the mean ---#
    .[, dev_input_rate := sum(abs(sub_pct * (input_rate - wm_input_rate) / tot_sub_pct)), by = yield_id] %>%
    #--- order by yield_id ---#
    .[order(yield_id), ] %>%
    .[, .(
      yield_id,
      tot_sub_pct,
      wm_input_rate,
      dev_input_rate
    )] %>%
    setnames("wm_input_rate", "input_rate") %>%
    unique(by = "yield_id") 
  )) %>% 
  dplyr::select(input_type, form, yield_input_int, input_pct_data) %>% 
  mutate(
    #=== visualize overlap ===#
    gg_overlap = list(
      ggplot(input_pct_data) +
      geom_histogram(aes(x = tot_sub_pct)) +
      ggtitle(
        paste(
          "Histogram of the percentage of yield polygons \n overlapping with", 
          input_type, 
          "polygons"
        )
      )     
    ),
    #=== visualize mix of rates ===#
    gg_dev = list(
      ggplot(input_pct_data) +
      geom_histogram(aes(x = dev_input_rate)) +
      ggtitle(
        paste(
          "Histogram of the deviation of ",
          input_type, 
          "\n to its mean by yield_id"
        )
      )     
    )
  )

```

```{r }
input_pct$gg_overlap

input_pct$gg_dev
```

### An example polygon with a problem

```{r }
temp_yield_id <- input_pct$input_pct_data[[1]][tot_sub_pct > 2, yield_id][1] 

overlapping_input <- input_pct$yield_input_int[[1]][yield_id == temp_yield_id] 

temp_yield_poly <- filter(yield_polygons, yield_id == temp_yield_id)

ggplot() +
  geom_sf(data = st_as_sf(overlapping_input), aes(fill = factor(input_rate)), alpha = 0.5) +
  geom_sf(data = temp_yield_poly, color = "red", fill = NA, size = 1)

```

### Flag unreliable observations

```{r }
max_dev_dt <- max_dev_table[crop == trial_pars$crop, ]
#=== convert max_dev_table if in ha instead of ac ===#

if(units == "metric"){
  max_dev_dt[, max_dev_allowed := max_dev_allowed * 2.47105] 
}

#=== yield data after removing unreliable inputs ===#
yield_input_data_pre <- 
  input_pct %>% 
  dplyr::select(input_type, form, input_pct_data) %>% 
  left_join(max_dev_dt, by = "input_type") %>% 
  mutate(input_pct_data_pre = list(
      data.table::copy(input_pct_data) %>% 
      #=== 1 means within the threshold ===#
      .[, over_lap_test := fifelse(tot_sub_pct > 0.9 & tot_sub_pct < 1.1, 1, 0)] %>% 
      #=== 1 means okay ===#
      .[, deviation_test := fifelse(dev_input_rate < max_dev_allowed, 1, 0)] %>% 
      .[, .(yield_id, input_rate, over_lap_test, deviation_test)]
  )) %>% 
  mutate(input_pct_data_out = list(
    copy(input_pct_data_pre) %>% 
      setnames(
        "input_rate",
        paste0(tolower(input_type), "_rate", "_", form)
      ) %>% 
      setnames(
        c("over_lap_test", "deviation_test"),
        c(
          paste0(tolower(input_type), "_", form, "_over_lap_test"),
          paste0(tolower(input_type), "_", form, "_deviation_test")
        )
      )
  ))

yield_input_data <-
  yield_input_data_pre %>% 
  pull(input_pct_data_out) %>% 
  reduce(inner_join, by = "yield_id") %>% 
  inner_join(yield_polygons, ., by = "yield_id") %>% 
  #=== add base n-rate column ===#
  mutate(n_base = n_base) 

```

### Alignment with Trial Design

```{r }
yield_trd <- 
  st_intersection(yield_polygons, trd_polygons) %>% 
  arrange(yield_id) %>% 
  mutate(int_area = as.numeric(st_area(.))) %>% 
  data.table()  

dt_trd_int <- tibble(type = "trial-design", int_info = list(yield_trd))

dt_input_int <- 
  input_pct %>% 
  mutate(type = paste0(input_type, "-", form)) %>% 
  dplyr::select(type, yield_input_int) %>% 
  rename(int_info = yield_input_int)

detailed_int_data <- 
  rbind(dt_trd_int, dt_input_int) %>% 
  #=== add base n-rate column ===#
  mutate(n_base = n_base)

```

### Visualization

```{r }
viz <- 
  yield_input_data_pre %>% 
  mutate(input_data_viz = list(
    inner_join(yield_polygons, input_pct_data_pre, by = "yield_id") %>% 
    st_as_sf()
  )) %>% 
  dplyr::select(input_type, form, input_data_viz) %>% 
  mutate(viz_overlap = list(
    ggplot(data = input_data_viz) +
    geom_sf(aes(fill = (over_lap_test == 1))) +
    scale_fill_discrete(name = form)
  )) %>% 
  mutate(viz_deviation = list(
    ggplot(data = input_data_viz) +
    geom_sf(aes(fill = (deviation_test == 1))) +
    scale_fill_discrete(name = form)
  )) 

```

**Overlap (1 means passing the overlap test)**

```{r }
viz$viz_overlap

```

**Deviation (1 means passing the deviation test)**

```{r }
viz$viz_deviation

```

## Save

```{r }
saveRDS(yield_input_data, file = here("Data", "Growers", ffy, "Analysis-Ready/analysis_data.rds"))

saveRDS(detailed_int_data, file = here("Data", "Growers", ffy, "DataProcessingReport/detailed_intersection_info.rds"))
```


