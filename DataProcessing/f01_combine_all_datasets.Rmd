# Preparation

## Read in yield datasets

```{r }
#--- yield ---#
yield_sf <-
  here("Data/Growers", ffy, "Intermediate/yield_input_data.rds") %>%
  readRDS()
```

```{r}
yield_point <-
  readRDS(
    here(
      "Data/Growers",
      ffy,
      "Intermediate/yield_point.rds"
    )
  )
```

# Overlay and merge the datasets

## Topography

```{r , results = "hide"}
topo_stars <-
  here("Data/Growers", ffy, "Intermediate/topography.rds") %>%
  readRDS()

topo_values <-
  topo_stars %>%
  stars_to_stack() %>%
  exact_extract(., st_transform(yield_sf, st_crs(.))) %>%
  rbindlist(idcol = "rowid") %>%
  .[,
    lapply(.SD, weighted.mean, w = coverage_fraction),
    by = rowid,
    .SDcols = paste0("layer.", 1:length(topo_stars))
  ] %>%
  .[, rowid := NULL] %>%
  setnames(names(.), names(topo_stars))

yield_sf <- cbind(yield_sf, topo_values)
```

## SSURGO

```{r , results = "hide"}
ssurgo_sf <-
  here("Data/Growers", ffy, "Intermediate/ssurgo.rds") %>%
  readRDS() %>%
  st_transform(st_crs(yield_sf))

ssurgo_values <-
  dplyr::select(yield_sf, yield_id) %>%
  st_intersection(., ssurgo_sf) %>%
  mutate(area = as.numeric(st_area(.))) %>%
  data.table() %>%
  .[, area_pct := area / sum(area), by = yield_id] %>%
  .[,
    lapply(.SD, weighted.mean, w = area_pct),
    by = yield_id,
    .SDcols = c("sandtotal_r", "silttotal_r", "claytotal_r", "awc_r", "om_r", "dbovendry_r")
  ]

yield_sf <- left_join(yield_sf, ssurgo_values, by = "yield_id")

```

## Rx

```{r }
cm_rx_data <-
  trial_info$rx_data %>%
  rowwise() %>%
  mutate(cm_rx = list(
    st_read(here("Data/Growers", ffy, "Raw", file))
  )) %>%
  mutate(yield_cm_rx = list(
    st_intersection(yield_point, st_transform(cm_rx, st_crs(yield_point))) %>%
      data.table() %>%
      .[, c("yield_id", form), with = FALSE] %>%
      setnames(form, paste0(form, "_", model))
  )) %>%
  pull(yield_cm_rx) %>%
  reduce(left_join, by = "yield_id")
```

## Ex data

```{r }

ex_data <-
  trial_info$ex_data %>%
  rowwise() %>%
  mutate(data = list(
    st_read(here("Data/Growers", ffy, "Raw", file))
  ))
```


